asyncapi: 3.0.0
info:
  title: Vehicle-to-Cloud Communications API
  version: 1.0.0
  description: |
    **Production-ready MQTT 5.0 communications architecture for connected vehicles**

    This API defines the complete message protocol for bidirectional communication between
    vehicles and cloud infrastructure using MQTT 5.0 over AWS IoT Core.

    ## Key Features
    - **Protocol**: MQTT 5.0 with QoS 1-2 guarantees
    - **Security**: Mutual TLS (mTLS) with X.509 certificates
    - **Serialization**: Protocol Buffers (proto3)
    - **Bandwidth Optimization**: Topic aliases (96% overhead reduction)
    - **Cost Savings**: $2.73M annually for 1M vehicle fleet

    ## Message Domains
    1. **Telemetry**: Vehicle sensor data and diagnostics
    2. **Commands**: Remote vehicle control operations
    3. **OTA Updates**: Firmware/software update lifecycle
    4. **Diagnostics**: DTC reporting and health monitoring

    ## Compliance
    - ISO 21434 (Automotive Cybersecurity)
    - GDPR/CCPA (Data Privacy)
    - SOC 2 Type II (Security Audit)
    - ISO 27001 (Information Security)

  contact:
    name: API Support
    email: api-support@example.com
    url: https://github.com/jamesenki/vehicle-to-cloud-communications-architecture

  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  production-us-east-1:
    host: a1b2c3d4e5f6g7.iot.us-east-1.amazonaws.com
    protocol: mqtts
    description: AWS IoT Core - US East (Virginia)
    protocolVersion: '5.0'
    security:
      - $ref: '#/components/securitySchemes/X509'
    bindings:
      mqtt:
        clientId: '{vehicle_id}'
        cleanSession: false
        sessionExpiryInterval: 3600
        keepAlive: 300
        maximumPacketSize: 131072

  production-eu-west-1:
    host: h8i9j0k1l2m3n4.iot.eu-west-1.amazonaws.com
    protocol: mqtts
    description: AWS IoT Core - EU West (Ireland)
    protocolVersion: '5.0'
    security:
      - $ref: '#/components/securitySchemes/X509'

defaultContentType: application/x-protobuf

channels:
  vehicleTelemetry:
    address: 'v2c/v1/{region}/{vehicle_id}/telemetry/vehicle'
    title: Vehicle Telemetry Stream
    description: Real-time vehicle sensor data published by the vehicle
    parameters:
      region:
        description: AWS region identifier
        enum: ['us-east-1', 'eu-west-1', 'ap-southeast-1']
      vehicle_id:
        description: Vehicle identification number prefixed with VIN-
        pattern: '^VIN-[A-Z0-9]{17}$'
        examples:
          - 'VIN-1HGBH41JXMN109186'
    messages:
      VehicleTelemetry:
        $ref: '#/components/messages/VehicleTelemetry'
    bindings:
      mqtt:
        qos: 1
        retain: false

  telemetryBatch:
    address: 'v2c/v1/{region}/{vehicle_id}/telemetry/batch'
    title: Batched Telemetry
    description: Aggregated telemetry messages for bandwidth optimization (96% savings)
    parameters:
      region:
        $ref: '#/channels/vehicleTelemetry/parameters/region'
      vehicle_id:
        $ref: '#/channels/vehicleTelemetry/parameters/vehicle_id'
    messages:
      TelemetryBatch:
        $ref: '#/components/messages/TelemetryBatch'
    bindings:
      mqtt:
        qos: 1
        retain: false

  commandRequest:
    address: 'v2c/v1/{region}/{vehicle_id}/command/request'
    title: Remote Command Requests
    description: Cloud sends remote commands to vehicle (lock doors, start climate, etc.)
    parameters:
      region:
        $ref: '#/channels/vehicleTelemetry/parameters/region'
      vehicle_id:
        $ref: '#/channels/vehicleTelemetry/parameters/vehicle_id'
    messages:
      RemoteCommandRequest:
        $ref: '#/components/messages/RemoteCommandRequest'
    bindings:
      mqtt:
        qos: 1
        retain: false

  commandResponse:
    address: 'v2c/v1/{region}/{vehicle_id}/command/response'
    title: Command Responses
    description: Vehicle acknowledges and reports command execution status
    parameters:
      region:
        $ref: '#/channels/vehicleTelemetry/parameters/region'
      vehicle_id:
        $ref: '#/channels/vehicleTelemetry/parameters/vehicle_id'
    messages:
      RemoteCommandResponse:
        $ref: '#/components/messages/RemoteCommandResponse'
    bindings:
      mqtt:
        qos: 1
        retain: false

  otaAvailable:
    address: 'v2c/v1/{region}/{vehicle_id}/ota/available'
    title: OTA Update Notification
    description: Cloud notifies vehicle that a software update is available
    parameters:
      region:
        $ref: '#/channels/vehicleTelemetry/parameters/region'
      vehicle_id:
        $ref: '#/channels/vehicleTelemetry/parameters/vehicle_id'
    messages:
      OTAUpdateAvailable:
        $ref: '#/components/messages/OTAUpdateAvailable'
    bindings:
      mqtt:
        qos: 2  # Exactly once for safety-critical OTA
        retain: false

  otaAccept:
    address: 'v2c/v1/{region}/{vehicle_id}/ota/accept'
    title: OTA Update Acceptance
    description: Vehicle accepts or defers the update offer
    parameters:
      region:
        $ref: '#/channels/vehicleTelemetry/parameters/region'
      vehicle_id:
        $ref: '#/channels/vehicleTelemetry/parameters/vehicle_id'
    messages:
      OTAUpdateAccept:
        $ref: '#/components/messages/OTAUpdateAccept'
    bindings:
      mqtt:
        qos: 1
        retain: false

  otaProgress:
    address: 'v2c/v1/{region}/{vehicle_id}/ota/progress'
    title: OTA Progress Updates
    description: Vehicle reports download and installation progress
    parameters:
      region:
        $ref: '#/channels/vehicleTelemetry/parameters/region'
      vehicle_id:
        $ref: '#/channels/vehicleTelemetry/parameters/vehicle_id'
    messages:
      OTADownloadProgress:
        $ref: '#/components/messages/OTADownloadProgress'
      OTAInstallProgress:
        $ref: '#/components/messages/OTAInstallProgress'
    bindings:
      mqtt:
        qos: 1
        retain: false

  diagnosticsDTC:
    address: 'v2c/v1/{region}/{vehicle_id}/diagnostics/dtc'
    title: Diagnostic Trouble Codes
    description: Vehicle reports active or stored DTCs with freeze frames
    parameters:
      region:
        $ref: '#/channels/vehicleTelemetry/parameters/region'
      vehicle_id:
        $ref: '#/channels/vehicleTelemetry/parameters/vehicle_id'
    messages:
      DTCReport:
        $ref: '#/components/messages/DTCReport'
    bindings:
      mqtt:
        qos: 1
        retain: false

operations:
  publishTelemetry:
    action: send
    channel:
      $ref: '#/channels/vehicleTelemetry'
    title: Publish Vehicle Telemetry
    summary: Vehicle publishes real-time sensor data every 1-10 minutes
    description: |
      Vehicles continuously publish telemetry data including:
      - Speed, RPM, gear position
      - Battery voltage, fuel level
      - Engine temperature, oil pressure
      - GPS location (if consent given)

    traits:
      - $ref: '#/components/operationTraits/vehiclePublish'

  publishBatchTelemetry:
    action: send
    channel:
      $ref: '#/channels/telemetryBatch'
    title: Publish Batched Telemetry
    summary: Vehicle publishes 25-50 aggregated messages for bandwidth savings
    description: |
      Batch telemetry reduces MQTT overhead by 96% and saves $2.73M annually
      for a 1M vehicle fleet. Messages are compressed with ZSTD for additional
      60-80% payload reduction.

    traits:
      - $ref: '#/components/operationTraits/vehiclePublish'

  receiveCommand:
    action: receive
    channel:
      $ref: '#/channels/commandRequest'
    title: Receive Remote Command
    summary: Vehicle receives and validates remote commands from cloud
    description: |
      Supports 10 command types:
      - Lock/unlock doors
      - Start/stop climate control
      - Remote engine start
      - Horn and lights
      - Charge control (EVs)

      Commands are validated for preconditions (speed, battery, gear) before execution.

    traits:
      - $ref: '#/components/operationTraits/vehicleReceive'

  publishCommandResponse:
    action: send
    channel:
      $ref: '#/channels/commandResponse'
    title: Publish Command Response
    summary: Vehicle acknowledges command and reports execution status

    traits:
      - $ref: '#/components/operationTraits/vehiclePublish'

  receiveOTANotification:
    action: receive
    channel:
      $ref: '#/channels/otaAvailable'
    title: Receive OTA Update Notification
    summary: Cloud notifies vehicle of available firmware/software update
    description: |
      OTA updates support:
      - Full system images and delta patches
      - Security patches (critical priority)
      - Feature updates and bug fixes
      - Automatic rollback on failure

    traits:
      - $ref: '#/components/operationTraits/cloudPublish'

  publishOTAAcceptance:
    action: send
    channel:
      $ref: '#/channels/otaAccept'
    title: Accept or Defer Update
    summary: Vehicle accepts, defers, or rejects the update offer

    traits:
      - $ref: '#/components/operationTraits/vehiclePublish'

  publishOTAProgress:
    action: send
    channel:
      $ref: '#/channels/otaProgress'
    title: Report OTA Progress
    summary: Vehicle reports download/installation progress every 10%

    traits:
      - $ref: '#/components/operationTraits/vehiclePublish'

  publishDTCs:
    action: send
    channel:
      $ref: '#/channels/diagnosticsDTC'
    title: Report Diagnostic Trouble Codes
    summary: Vehicle reports active DTCs with freeze frame data
    description: |
      Diagnostic reporting includes:
      - DTC code (e.g., P0171, C0035)
      - Severity level (info, low, medium, high, critical)
      - Freeze frame (vehicle state when DTC set)
      - Occurrence count and timestamps
      - Recommended action

    traits:
      - $ref: '#/components/operationTraits/vehiclePublish'

components:
  messages:
    VehicleTelemetry:
      name: VehicleTelemetry
      title: Vehicle Telemetry Message
      summary: Real-time vehicle sensor data
      contentType: application/x-protobuf
      payload:
        $ref: '#/components/schemas/VehicleTelemetryProto'
      examples:
        - name: NormalDriving
          summary: Vehicle driving at highway speed
          payload:
            speed: 105.5
            engine_rpm: 2200
            fuel_level: 68.5
            battery_voltage: 14.2
            coolant_temp: 92.0
            odometer: 125430
            gear: 'D'
            throttle_position: 42.0

    TelemetryBatch:
      name: TelemetryBatch
      title: Batched Telemetry Messages
      summary: 25-50 aggregated telemetry messages
      contentType: application/x-protobuf
      payload:
        $ref: '#/components/schemas/TelemetryBatchProto'
      examples:
        - name: HourlyBatch
          summary: One hour of telemetry data (25 messages)
          payload:
            batch_id: '550e8400-e29b-41d4-a716-446655440000'
            message_count: 25
            compression: 'ZSTD'
            compressed_size_bytes: 4096
            uncompressed_size_bytes: 12288

    RemoteCommandRequest:
      name: RemoteCommandRequest
      title: Remote Command Request
      summary: Cloud sends remote command to vehicle
      contentType: application/x-protobuf
      payload:
        $ref: '#/components/schemas/RemoteCommandRequestProto'
      examples:
        - name: LockDoors
          summary: Lock all doors and enable alarm
          payload:
            command_id: '7b3e1d5a-9f2c-4a6b-8e0d-3c4f5a6b7c8d'
            user_id: 'user-12345'
            lock_doors:
              lock_trunk: true
              enable_alarm: true
              flash_lights: true
            priority: 'NORMAL'
            timeout_seconds: 30

    RemoteCommandResponse:
      name: RemoteCommandResponse
      title: Command Response
      summary: Vehicle acknowledges command
      contentType: application/x-protobuf
      payload:
        $ref: '#/components/schemas/RemoteCommandResponseProto'

    OTAUpdateAvailable:
      name: OTAUpdateAvailable
      title: OTA Update Notification
      summary: Notify vehicle of available update
      contentType: application/x-protobuf
      payload:
        $ref: '#/components/schemas/OTAUpdateAvailableProto'
      examples:
        - name: SecurityPatch
          summary: Critical security update
          payload:
            update_id: 'ota-2025-001'
            version: '2.5.1'
            update_type: 'SECURITY_PATCH'
            priority: 'CRITICAL'
            size_bytes: 52428800
            min_battery_level: 30
            can_install_while_driving: false

    OTAUpdateAccept:
      name: OTAUpdateAccept
      title: OTA Update Acceptance
      summary: Vehicle accepts or defers update
      contentType: application/x-protobuf
      payload:
        $ref: '#/components/schemas/OTAUpdateAcceptProto'

    OTADownloadProgress:
      name: OTADownloadProgress
      title: OTA Download Progress
      summary: Download progress report
      contentType: application/x-protobuf
      payload:
        $ref: '#/components/schemas/OTADownloadProgressProto'

    OTAInstallProgress:
      name: OTAInstallProgress
      title: OTA Installation Progress
      summary: Installation progress report
      contentType: application/x-protobuf
      payload:
        $ref: '#/components/schemas/OTAInstallProgressProto'

    DTCReport:
      name: DTCReport
      title: Diagnostic Trouble Code Report
      summary: Active or stored DTCs with freeze frames
      contentType: application/x-protobuf
      payload:
        $ref: '#/components/schemas/DTCReportProto'
      examples:
        - name: EngineLeanCondition
          summary: Engine running too lean
          payload:
            dtcs:
              - code: 'P0171'
                description: 'System Too Lean (Bank 1)'
                severity: 'MEDIUM'
                category: 'POWERTRAIN'
                status: 'ACTIVE'
                occurrence_count: 3
                freeze_frame:
                  engine_rpm: 2200
                  speed_kmh: 80.0
                  throttle_position_percent: 42.0

  schemas:
    VehicleTelemetryProto:
      type: object
      description: Protocol Buffer message (see src/main/proto/V2C/Telemetry.proto)
      properties:
        speed:
          type: number
          description: Vehicle speed in km/h
        engine_rpm:
          type: integer
          description: Engine RPM
        fuel_level:
          type: number
          description: Fuel level percentage (0-100)
        battery_voltage:
          type: number
          description: Battery voltage in volts
        metadata:
          $ref: '#/components/schemas/MessageMetadata'

    TelemetryBatchProto:
      type: object
      description: Protocol Buffer message (see src/main/proto/V2C/TelemetryBatch.proto)
      properties:
        batch_id:
          type: string
          format: uuid
        message_count:
          type: integer
        compression:
          type: string
          enum: [NONE, GZIP, ZSTD, LZ4]
        telemetry_messages:
          type: array
          items:
            $ref: '#/components/schemas/VehicleTelemetryProto'

    RemoteCommandRequestProto:
      type: object
      description: Protocol Buffer message (see src/main/proto/V2C/Commands.proto)
      properties:
        command_id:
          type: string
          format: uuid
        user_id:
          type: string
        priority:
          type: string
          enum: [NORMAL, HIGH, CRITICAL]
        timeout_seconds:
          type: integer

    RemoteCommandResponseProto:
      type: object
      description: Protocol Buffer message (see src/main/proto/V2C/Commands.proto)
      properties:
        command_id:
          type: string
        status:
          type: string
          enum: [ACCEPTED, REJECTED, FAILED, COMPLETED, DUPLICATE, EXPIRED, CANCELLED]

    OTAUpdateAvailableProto:
      type: object
      description: Protocol Buffer message (see src/main/proto/V2C/OTA.proto)
      properties:
        update_id:
          type: string
        version:
          type: string
        update_type:
          type: string
          enum: [FULL_SYSTEM, DELTA, SECURITY_PATCH, FEATURE, BUGFIX, CONFIG]
        priority:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
        size_bytes:
          type: integer

    OTAUpdateAcceptProto:
      type: object
      description: Protocol Buffer message (see src/main/proto/V2C/OTA.proto)

    OTADownloadProgressProto:
      type: object
      description: Protocol Buffer message (see src/main/proto/V2C/OTA.proto)

    OTAInstallProgressProto:
      type: object
      description: Protocol Buffer message (see src/main/proto/V2C/OTA.proto)

    DTCReportProto:
      type: object
      description: Protocol Buffer message (see src/main/proto/V2C/Diagnostics.proto)

    MessageMetadata:
      type: object
      properties:
        message_id:
          type: string
          format: uuid
        timestamp:
          type: integer
          format: int64
          description: EPOCH milliseconds
        vehicle_id:
          type: string
        region:
          type: string

  securitySchemes:
    X509:
      type: X509
      description: |
        Mutual TLS authentication using X.509 certificates

        **Certificate Requirements:**
        - Algorithm: ECC P-256 or RSA 2048-bit
        - Validity: 1 year (automatic rotation)
        - Storage: HSM/TPM (FIPS 140-2 Level 2+)
        - CN: Vehicle VIN

        **Certificate Chain:**
        - Root CA (20-year, offline, air-gapped)
        - Intermediate CA (10-year, online)
        - Device Issuing CA (5-year)
        - Vehicle Certificate (1-year)

  operationTraits:
    vehiclePublish:
      bindings:
        mqtt:
          qos: 1
          retain: false

    vehicleReceive:
      bindings:
        mqtt:
          qos: 1

    cloudPublish:
      bindings:
        mqtt:
          qos: 2  # Exactly once for safety-critical

tags:
  - name: Telemetry
    description: Real-time vehicle sensor data and diagnostics
  - name: Commands
    description: Remote vehicle control operations
  - name: OTA
    description: Over-the-air firmware/software updates
  - name: Diagnostics
    description: DTCs, health monitoring, and predictive maintenance

externalDocs:
  description: Complete API Reference and Implementation Guide
  url: https://github.com/jamesenki/vehicle-to-cloud-communications-architecture/blob/main/docs/api/API_REFERENCE.md
